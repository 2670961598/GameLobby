# 多人游戏服务器测试脚本使用指南

## 概述

本测试脚本已升级为增强版，支持多种测试模式，包括多房间混合同步测试和高压力测试。

## 功能特性

### 🎯 1. 基本功能测试

- 房间创建、加入、退出
- 权限控制验证
- 错误处理机制
- WebSocket连接稳定性

### 🏠 2. 多房间混合同步测试（新增）

- **同时运行多个房间**（默认5个房间）
- **混合同步模式**：状态同步 + 帧同步 + 自定义同步
- **实时消息记录**：详细记录帧同步消息时序
- **性能分析**：帧率精确度、消息频率统计

### ⚡ 3. 高压力测试（新增）

- **大规模并发**：最多150+玩家同时在线
- **性能监控**：响应时间、成功率、资源使用
- **批量操作**：并发房间创建、连接建立
- **系统资源检查**：内存、CPU使用率监控

### 🔒 4. 安全性测试

- SQL注入攻击防护
- XSS攻击防护
- 越权操作防护
- 大数据负载防护

### 🌐 5. P2P模式测试

- 点对点连接测试
- 房主IP信息验证

## 使用方法

### 基本语法

```bash
python test/server_test.py [模式]
```

### 测试模式

#### 1. 全面测试（默认）

```bash
python test/server_test.py
# 或
python test/server_test.py all
```

- **耗时**：15-20分钟
- **覆盖**：所有测试项目
- **适用**：正式发布前的完整验证

#### 2. 快速测试

```bash
python test/server_test.py quick
```

- **耗时**：3-5分钟
- **覆盖**：基本功能 + 小规模多房间测试
- **适用**：开发阶段的快速验证

#### 3. 压力测试

```bash
python test/server_test.py stress
```

- **耗时**：8-12分钟
- **覆盖**：多房间混合同步 + 高压力测试
- **适用**：性能评估和压力测试

#### 4. 多房间混合同步测试

```bash
python test/server_test.py mixed
```

- **耗时**：5-8分钟
- **规模**：5房间 x 6玩家 = 30并发
- **适用**：同步机制验证

#### 5. 高压力测试

```bash
python test/server_test.py pressure
```

- **耗时**：10-15分钟
- **规模**：10房间 x 15玩家 = 150并发
- **适用**：最大负载测试

#### 6. 帧同步专项测试

```bash
python test/server_test.py frame
```

- **耗时**：5-8分钟
- **专注**：帧同步精确度和性能
- **适用**：帧同步功能深度验证

## 测试规模对比

| 测试模式 | 房间数 | 每房间玩家 | 总并发数 | 测试时长  | 适用场景 |
| -------- | ------ | ---------- | -------- | --------- | -------- |
| quick    | 3      | 3          | 9        | 3-5分钟   | 开发验证 |
| mixed    | 5      | 6          | 30       | 5-8分钟   | 同步测试 |
| stress   | 6+8    | 8+12       | 48+96    | 8-12分钟  | 压力测试 |
| pressure | 10     | 15         | 150      | 10-15分钟 | 极限测试 |
| all      | 多种   | 多种       | 多种     | 15-20分钟 | 全面测试 |

## 测试报告解读

### 1. 混合同步测试报告

```
📊 测试基本信息:
   测试房间数: 5 个
   每房间玩家数: 6 个
   总玩家数: 30 个
   测试持续时间: 65.2 秒

🏠 房间同步模式分布:
   帧同步房间: 2 个
   状态同步房间: 2 个
   自定义同步房间: 1 个

⚡ 帧同步详细分析:
   房间 12345:
     📡 消息总数: 1024
     🎯 平均帧率: 16.1 fps
     📈 间隔范围: 0.060s - 0.068s
     📊 稳定性(标准差): 0.003s
     🎮 Tick范围: 1 - 1024
```

### 2. 高压力测试报告

```
🎯 测试规模:
   房间数量: 10
   总玩家数: 150
   测试时长: 120 秒

⚡ 性能指标:
   连接建立: 平均 0.245s
   消息处理: 12450 成功, 23 失败
   消息频率: 103.8 消息/秒
   响应时间: 平均 0.156s

📊 测试结果: 8/10 通过
   ✅ 批量创建房间
   ✅ 大量连接建立
   ✅ 高并发消息成功率
   ❌ P95响应时间合格
```

## 系统要求

### 最低要求

- **内存**：4GB 可用内存
- **CPU**：2核心以上
- **网络**：稳定的本地网络连接

### 推荐配置

- **内存**：8GB+ 可用内存
- **CPU**：4核心以上
- **网络**：千兆网络

### 高压力测试要求

- **内存**：16GB+ 总内存，8GB+ 可用
- **CPU**：8核心以上
- **网络**：千兆网络 + 低延迟

## 注意事项

### ⚠️ 重要提醒

1. **资源监控**

   - 高压力测试会占用大量系统资源
   - 建议在专用测试环境中运行
   - 监控系统内存和CPU使用率
2. **网络要求**

   - 确保服务器正在运行且可访问
   - 检查防火墙设置
   - 本地测试建议使用localhost
3. **测试环境**

   - 避免在生产环境运行大规模测试
   - 确保测试数据不会影响正式数据
   - 建议使用独立的测试服务器

### 🐛 故障排除

#### 连接失败

```bash
# 检查服务器是否运行
curl http://172.18.67.143:11452/api/multiplayer/rooms

# 检查端口是否可访问
telnet 172.18.67.143 11452
```

#### 内存不足

```bash
# 检查可用内存
free -h

# 减少测试规模
python test/server_test.py quick
```

#### 测试超时

```bash
# 检查网络延迟
ping 172.18.67.143

# 使用快速测试模式
python test/server_test.py quick
```

## 测试结果分析

### 成功标准

1. **基本功能**：所有基本功能测试通过
2. **同步性能**：帧率误差<20%，消息传输成功率>90%
3. **压力测试**：连接成功率>80%，响应时间<2秒
4. **安全测试**：所有安全防护测试通过

### 性能指标

| 指标       | 优秀    | 良好     | 一般     | 需改进   |
| ---------- | ------- | -------- | -------- | -------- |
| 帧率精确度 | <5%误差 | <10%误差 | <20%误差 | >20%误差 |
| 连接成功率 | >95%    | >90%     | >80%     | <80%     |
| 响应时间   | <0.5s   | <1.0s    | <2.0s    | >2.0s    |
| 消息成功率 | >98%    | >95%     | >90%     | <90%     |

## 扩展功能

### 自定义测试参数

可以修改测试脚本中的参数来调整测试规模：

```python
# 多房间混合同步测试
mixed_sync_tester = MultiRoomMixedSyncTest(
    num_rooms=5,        # 房间数量
    players_per_room=6  # 每房间玩家数
)

# 高压力测试
high_pressure_tester = HighPressureTest(
    num_rooms=10,       # 房间数量
    players_per_room=15,# 每房间玩家数
    test_duration=90    # 测试持续时间（秒）
)
```

### 添加新测试项目

可以继承现有测试类来添加自定义测试：

```python
class CustomTest(MultiRoomMixedSyncTest):
    def custom_test_function(self):
        # 自定义测试逻辑
        pass
```

---

## 联系支持

如果在使用过程中遇到问题，请检查：

1. 服务器是否正常运行
2. 系统资源是否充足
3. 网络连接是否稳定
4. 测试参数是否合理

Happy Testing! 🚀
