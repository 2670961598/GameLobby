<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>吃豆人游戏</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: black;
            margin: 0;
        }
        #gameCanvas {
            border: 1px solid white;
            background-color: black;
        }
        #score, #timer {
            color: red;
            font-size: 24px;
            margin-bottom: 10px;
        }
        #nextLevelButton {
            display: none;
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 18px;
            color: white;
            background-color: green;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="score">积分: 0</div>
    <div id="timer">时间: 60</div>
    <canvas id="gameCanvas" width="440" height="440"></canvas>
    <button id="nextLevelButton">进入下一关</button>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const levels = [
            { size: 11, speed: 200 },
            { size: 13, speed: 180 },
            { size: 15, speed: 160 },
            { size: 17, speed: 140 },
            { size: 20, speed: 120 }
        ];
        let currentLevel = 0;
        let gridSize = 20;
        let pacmanSize = gridSize / 2;
        let pacman = { x: 1, y: 1, direction: 'right' };
        let maze = generateMaze(levels[currentLevel].size);
        let dots = generateDots(levels[currentLevel].size);
        let score = 0;
        let timeLeft = 60;
        const HOST = 'http://172.18.67.143:11452';
        const gameId = 'pacman';

        function generateMaze(size) {
            let maze = Array.from({ length: size }, () => Array(size).fill(0));
            for (let i = 0; i < size; i++) {
                maze[0][i] = 1;
                maze[size - 1][i] = 1;
                maze[i][0] = 1;
                maze[i][size - 1] = 1;
            }
            for (let i = 2; i < size - 2; i += 2) {
                for (let j = 2; j < size - 2; j += 2) {
                    maze[i][j] = 1;
                    let direction = Math.floor(Math.random() * 4);
                    if (direction === 0) maze[i - 1][j] = 1;
                    else if (direction === 1) maze[i + 1][j] = 1;
                    else if (direction === 2) maze[i][j - 1] = 1;
                    else if (direction === 3) maze[i][j + 1] = 1;
                }
            }
            return maze;
        }

        function generateDots(size) {
            let dots = [];
            for (let i = 1; i < size - 1; i++) {
                for (let j = 1; j < size - 1; j++) {
                    if (maze[i][j] === 0) {
                        dots.push({ x: j, y: i });
                    }
                }
            }
            return dots;
        }

        function drawMaze() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let y = 0; y < levels[currentLevel].size; y++) {
                for (let x = 0; x < levels[currentLevel].size; x++) {
                    if (maze[y][x] === 1) {
                        ctx.fillStyle = 'blue';
                        ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
                    }
                }
            }
        }

        function drawDots() {
            ctx.fillStyle = 'white';
            dots.forEach(dot => {
                ctx.beginPath();
                ctx.arc(dot.x * gridSize + gridSize / 2, dot.y * gridSize + gridSize / 2, gridSize / 6, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawPacman() {
            ctx.fillStyle = 'yellow';
            ctx.beginPath();
            ctx.arc(pacman.x * gridSize + gridSize / 2, pacman.y * gridSize + gridSize / 2, pacmanSize / 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function movePacman() {
            let newX = pacman.x;
            let newY = pacman.y;
            if (pacman.direction === 'right') newX++;
            else if (pacman.direction === 'left') newX--;
            else if (pacman.direction === 'up') newY--;
            else if (pacman.direction === 'down') newY++;

            if (maze[newY][newX] === 0) {
                pacman.x = newX;
                pacman.y = newY;
            }

            dots = dots.filter(dot => {
                if (dot.x === pacman.x && dot.y === pacman.y) {
                    score++;
                    document.getElementById('score').textContent = `积分: ${score}`;
                    return false;
                }
                return true;
            });

            if (dots.length === 0) {
                clearInterval(timerInterval);
                if (currentLevel < levels.length - 1) {
                    document.getElementById('nextLevelButton').style.display = 'block';
                } else {
                    alert(`恭喜通关！总得分：${score}`);
                }
            }
        }

        function submitScore(score) {
            const data = {
                game: gameId,
                difficulty: 'medium',
                name: prompt("请输入您的昵称：", "匿名玩家"),
                score: score
            };

            fetch(`${HOST}/submit-score`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('提交成绩成功:', data);
            })
            .catch((error) => {
                console.error('提交成绩失败:', error);
            });
        }

        function gameLoop() {
            movePacman();
            drawMaze();
            drawDots();
            drawPacman();
        }

        function resetLevel() {
            maze = generateMaze(levels[currentLevel].size);
            dots = generateDots(levels[currentLevel].size);
            pacman = { x: 1, y: 1, direction: 'right' };
            score = 0;
            document.getElementById('score').textContent = `积分: ${score}`;
            timeLeft = 60;
            document.getElementById('timer').textContent = `时间: ${timeLeft}`;
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            timeLeft--;
            document.getElementById('timer').textContent = `时间: ${timeLeft}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitScore(score);
                alert('时间到！游戏失败。');
                resetLevel();
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowRight') pacman.direction = 'right';
            else if (event.key === 'ArrowLeft') pacman.direction = 'left';
            else if (event.key === 'ArrowUp') pacman.direction = 'up';
            else if (event.key === 'ArrowDown') pacman.direction = 'down';
        });

        document.getElementById('nextLevelButton').addEventListener('click', () => {
            currentLevel++;
            document.getElementById('nextLevelButton').style.display = 'none';
            resetLevel();
        });

        let timerInterval = setInterval(updateTimer, 1000);
        setInterval(gameLoop, levels[currentLevel].speed);
    </script>
</body>
</html>