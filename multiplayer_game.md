# 联机游戏系统技术文档

## 1. 系统概述

联机游戏系统采用双层架构设计，分为 **Web服务器层** 和 **游戏服务器层**，支持两种联机模式：P2P模式和服务器中继模式。

### 1.1 架构图
```
┌─────────────────────────────────────────────────────────────┐
│                     Web服务器层                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │   create_room   │  │   join_room     │  │  room_list    │ │
│  │   (房间创建)     │  │   (加入房间)     │  │  (房间列表)    │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                    游戏服务器层                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │   update_info   │  │  submit_state   │  │    receive    │ │
│  │   (房间配置)     │  │   (发送消息)     │  │  (接收消息)    │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
│  ┌─────────────────┐                                         │
│  │   exit_room     │                                         │
│  │   (退出房间)     │                                         │
│  └─────────────────┘                                         │
└─────────────────────────────────────────────────────────────┘
```

## 2. 联机模式

### 2.1 P2P模式
- **服务器职责**：仅提供房主IP转发服务
- **游戏实现**：游戏内部实现真正的P2P连接和数据同步
- **自由度**：最高，用户可自定义任何同步策略

### 2.2 服务器中继模式
- **服务器职责**：负责消息转发、状态同步、帧同步
- **同步类型**：支持状态同步和帧同步两种标准模式
- **适用场景**：标准化联机需求，降低游戏开发复杂度

## 3. 数据结构设计

### 3.1 房间ID生成规则
```javascript
房间ID = 时间戳 + 随机正整数
例如: 1703123456789123456
```

### 3.2 create_room 数据格式
```json
{
  "房间名": "string - 用户自定义房间名称",
  "房间ID": "string - 系统生成的唯一标识",
  "房主IP": "string - 房主的IP地址",
  "房间当前玩家数量": "number - 当前在房间内的玩家数",
  "房间人数上限": "number - 最大20人，默认值"
}
```

### 3.3 update_info 数据格式
```json
{
  "游戏模式": "string - p2p/服务器中继",
  "同步类型": "string - 状态同步/帧同步/用户自定义",
  "房间内玩家IP列表": ["string[] - 所有在线玩家的IP"],
  "用户自定义信息": "object - 游戏特定的配置数据"
}
```

## 4. 接口设计

### 4.1 Web服务器接口

#### 4.1.1 创建房间
- **接口**: `POST /api/multiplayer/create_room`
- **功能**: 创建新的联机房间
- **调用时机**: 多人游戏入口页面，用户输入房间名后自动调用
- **权限**: 任何用户都可创建
- **参数**: 房间名称
- **返回**: 房间ID、房主IP

#### 4.1.2 获取房间列表
- **接口**: `GET /api/multiplayer/rooms`
- **功能**: 获取所有未关闭的房间列表
- **返回**: 房间基本信息数组

#### 4.1.3 加入房间
- **接口**: `POST /api/multiplayer/join_room`
- **功能**: 
  - P2P模式：返回房主IP
  - 服务器中继模式：加入游戏服务器
- **参数**: 房间ID
- **返回**: 根据房间模式返回不同信息

### 4.2 游戏服务器接口

#### 4.2.1 更新房间信息
- **接口**: `POST /api/multiplayer/update_info`
- **功能**: 初始化或更新房间配置
- **权限**: 仅房主可调用
- **调用场景**:
  - 首次调用：确定同步类型，创建游戏服务器实例
  - 后续调用：更新房间配置、处理玩家变动

#### 4.2.2 退出房间
- **接口**: `POST /api/multiplayer/exit_room`
- **功能**: 玩家退出房间
- **特殊处理**: 房主退出时销毁整个房间

#### 4.2.3 发送状态/操作
- **接口**: `POST /api/multiplayer/submit_state`
- **功能**: 发送游戏状态或操作指令
- **数据隔离**: 服务器不解析内容，仅做转发

#### 4.2.4 接收消息
- **接口**: `WebSocket /api/multiplayer/receive`
- **功能**: 实时接收房间内的消息
- **连接模式**: 长连接

## 5. 同步机制详解

### 5.1 状态同步
```
工作流程:
1. 玩家调用 submit_state 发送完整游戏状态
2. 服务器保存最后一次状态数据 (最大10MB)
3. 服务器广播状态给房间内所有玩家
4. 新玩家加入时，立即同步最后保存的状态

适用场景:
- 回合制游戏
- 状态变化较少的游戏
- 支持中途加入的游戏
```

### 5.2 帧同步
```
工作流程:
1. 服务器以16 tick/秒的频率运行 (62.5ms间隔)
2. 玩家操作通过 submit_state 发送到操作队列
3. 每个玩家维护独立的操作队列 (最大10个操作)
4. 每个tick时，同步所有玩家的操作队列给房间内所有人
5. 同步后清空操作队列

队列处理:
- 无操作时同步空队列
- 多操作时按接收顺序排队
- 队列满时丢弃最旧操作

适用场景:
- 实时对战游戏
- 需要精确同步的游戏
- 操作频繁的游戏
```

## 6. 房间生命周期

### 6.1 创建阶段
1. 用户在多人游戏入口选择"创建房间"
2. 输入房间名称，调用 `create_room`
3. 系统生成房间ID，记录房主IP
4. 返回房间信息，进入游戏页面

### 6.2 配置阶段
1. 游戏页面加载完成后，房主调用 `update_info`
2. 首次调用确定游戏模式和同步类型
3. 根据配置创建对应的游戏服务器实例

### 6.3 运行阶段
1. 其他玩家通过 `join_room` 加入
2. 使用 `submit_state` 和 `receive` 进行游戏交互
3. 通过 `update_info` 处理配置变更和玩家变动

### 6.4 销毁阶段
1. 房主调用 `exit_room` 或连接断开
2. 系统通知所有玩家房间关闭
3. 清理内存中的房间数据和游戏服务器实例

## 7. 技术实现要点

### 7.1 内存存储
- 所有房间数据仅存储在内存中
- 服务器重启时所有房间数据丢失
- 不做持久化和备份

### 7.2 连接管理
- WebSocket连接用于实时消息推送
- 连接断开自动清理相关资源
- 房主连接断开时关闭整个房间

### 7.3 数据传输
- 服务器不解析游戏数据内容
- 支持任意格式的数据传输
- 大数据需游戏自行分包处理

### 7.4 扩展性设计
- 预留房主转移接口
- 支持用户自定义同步类型
- 模块化的游戏服务器实例管理

## 8. 目录结构

```
templates/
├── games/              # 单机游戏
└── multiplayer_games/  # 多人游戏
    ├── game1/
    │   ├── index.html
    │   └── ...
    └── game2/
        ├── index.html
        └── ...
```

## 9. 安全考虑

### 9.1 权限控制
- 只有房主可调用 `update_info`
- IP验证确保操作权限
- 房间访问权限检查

### 9.2 资源限制
- 房间人数上限：20人
- 状态数据大小限制：10MB
- 操作队列长度限制：10个

### 9.3 异常处理
- 连接断开自动清理
- 恶意数据隔离处理
- 房间异常状态恢复机制 